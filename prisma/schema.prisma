generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  super_admin
  admin
  manager
  employee
}

enum Action {
  create
  read
  update
  delete
}

enum Status {
  active
  inactive
  pending
  suspended
}

enum TaxMode {
  inclusive
  exclusive
}

enum Tier {
  free
  basic
  premium
}

enum SupplierState {
  primary
  secondary
}

model Clients {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  databaseUrl String
  tier      Tier
  dataSizeMB  String?
  status    Status   @default(active)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    Users[]
  stores   Stores[]
  products Products[]
}

model Users {
  id           String   @id @default(uuid())
  googleId     String?  @unique
  firstName    String
  lastName     String
  email        String   @unique
  passwordHash String?
  googleRefreshToken String?
  otp          String?
  otpExpiresAt DateTime?
  isOtpUsed    Boolean?  @default(false)
  role         Role
  clientId     String
  status       Status   @default(active)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Employee fields (previously in Employee model)
  employeeCode String?  @unique
  position     String?
  department   String?
  phone        String?

  client         Clients           @relation(fields: [clientId], references: [id])
  stores         UserStoreMap[]
  inviteLinks    InviteLinks[]
  
  // New permission system relations
  permissions        Permission[]   @relation("UserPermissions")
  grantedPermissions Permission[]   @relation("PermissionGrantedBy")
  createdRoleTemplates RoleTemplate[] @relation("CreatedRoleTemplates")
  userRoles          UserRole[]
  assignedUserRoles  UserRole[]     @relation("AssignedUserRoles")
  
  // Business operations (previously linked to Employee model)
  sales          Sales[]
  purchaseOrders PurchaseOrders[]
  expenses       Expenses[]
  
  notifications  Notifications[]
  auditLogs      AuditLogs[]
  apiTokens      ApiTokens[]
  passwordResetTokens PasswordResetTokens[]
}

model Stores {
  id          String   @id @default(uuid())
  name        String
  address     String?
  phone       String?
  email       String?
  clientId    String
  status      Status   @default(active)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client          Clients           @relation(fields: [clientId], references: [id])
  settings        StoreSettings?
  users           UserStoreMap[]
  permissions     Permission[]
  products        Products[]
  suppliers       Suppliers[]
  sales           Sales[]
  purchaseOrders  PurchaseOrders[]
  expenses        Expenses[]
  reports         Reports[]
  FileUploadInventory FileUploadInventory[]
  FileUploadSales     FileUploadSales[]
}

model StoreSettings {
  id                String   @id @default(uuid())
  storeId          String   @unique
  currency         String   @default("USD")
  timezone         String
  taxRate          Float    @default(0)
  taxMode          TaxMode  @default(exclusive)
  lowStockAlert    Int      @default(10)
  enableNotifications Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  store            Stores   @relation(fields: [storeId], references: [id])
}

model UserStoreMap {
  id        String   @id @default(uuid())
  userId    String
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      Users    @relation(fields: [userId], references: [id])
  store     Stores   @relation(fields: [storeId], references: [id])

  @@unique([userId, storeId])
}

model InviteLinks {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  role      Role
  userId    String
  status    Status   @default(pending)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      Users    @relation(fields: [userId], references: [id])
}


model Permission {
  id            String   @id @default(cuid())
  userId        String
  storeId       String?  // null = global permission
  resource      String   // 'inventory', 'product', 'store', etc.
  actions       String[] // Array of action strings (e.g., ['create', 'read', 'update'])
  resourceId    String?  // Specific resource ID (optional)
  granted       Boolean  @default(true)
  grantedBy     String
  grantedAt     DateTime @default(now())
  expiresAt     DateTime? // Optional permission expiration
  conditions    Json?    // Additional conditions
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          Users    @relation("UserPermissions", fields: [userId], references: [id], onDelete: Cascade)
  store         Stores?  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  grantedByUser Users    @relation("PermissionGrantedBy", fields: [grantedBy], references: [id])

  @@unique([userId, storeId, resource, resourceId])
  @@index([userId, storeId])
  @@index([resource])
  @@map("permissions")
}

model RoleTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json     // Array of permission objects
  inheritsFrom String? // Parent role template ID
  isDefault   Boolean  @default(false) // Default role for new users
  isActive    Boolean  @default(true)
  priority    Int      @default(0) // For permission conflict resolution
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creator     Users        @relation("CreatedRoleTemplates", fields: [createdBy], references: [id])
  parent      RoleTemplate? @relation("RoleInheritance", fields: [inheritsFrom], references: [id])
  children    RoleTemplate[] @relation("RoleInheritance")
  userRoles   UserRole[]

  @@map("role_templates")
}

model UserRole {
  id             String       @id @default(cuid())
  userId         String
  roleTemplateId String
  storeId        String?      // Store-specific role assignment
  assignedBy     String
  assignedAt     DateTime     @default(now())
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())

  // Relations
  user         Users        @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleTemplate RoleTemplate @relation(fields: [roleTemplateId], references: [id], onDelete: Cascade)
  assignedByUser Users      @relation("AssignedUserRoles", fields: [assignedBy], references: [id])

  @@unique([userId, roleTemplateId, storeId])
  @@map("user_roles")
}



model Notifications {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      Users    @relation(fields: [userId], references: [id])
}

model AuditLogs {
  id        String   @id @default(uuid())
  userId    String
  action    String
  resource  String
  details   Json?
  createdAt DateTime @default(now())

  user      Users    @relation(fields: [userId], references: [id])
}

model ApiTokens {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  name      String
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      Users    @relation(fields: [userId], references: [id])
}

model PasswordResetTokens {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Suppliers {
  id          String          @id @default(uuid())
  name        String
  email       String?
  phone       String
  address     String?
  storeId     String
  status      Status          @default(active)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  store       Stores          @relation(fields: [storeId], references: [id])
  productSuppliers ProductSupplier[] // Updated relation
  purchaseOrders  PurchaseOrders[]
}
model Sales {
  id          String   @id @default(uuid())
  productId   String
  userId      String
  storeId     String
  quantity    Int
  price       Float
  total       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  fileUploadSalesId String?
  FileUploadSales   FileUploadSales? @relation(fields: [fileUploadSalesId], references: [id])
  product     Products  @relation(fields: [productId], references: [id])
  user        Users     @relation(fields: [userId], references: [id])
  store       Stores    @relation(fields: [storeId], references: [id])
}

model PurchaseOrders {
  id          String   @id @default(uuid())
  productId   String
  supplierId  String
  userId      String
  storeId     String
  quantity    Int
  price       Float
  total       Float
  status      Status   @default(pending)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product     Products  @relation(fields: [productId], references: [id])
  supplier    Suppliers @relation(fields: [supplierId], references: [id])
  user        Users     @relation(fields: [userId], references: [id])
  store       Stores    @relation(fields: [storeId], references: [id])
}

model Expenses {
  id          String   @id @default(uuid())
  userId      String
  storeId     String
  amount      Float
  description String
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        Users     @relation(fields: [userId], references: [id])
  store       Stores    @relation(fields: [storeId], references: [id])
}

model Reports {
  id          String   @id @default(uuid())
  storeId     String
  type        String
  data        Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store       Stores    @relation(fields: [storeId], references: [id])
}

model ProductSupplier {
  id          String        @id @default(uuid())
  productId   String
  supplierId  String
  costPrice   Float
  category    String
  state       SupplierState @default(secondary) // First supplier will be set to primary in application logic
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  product     Products?      @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier    Suppliers?     @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
}

model Products {
  id                    String    @id @default(uuid())
  name                  String
  category              String
  ean                   String?
  pluUpc                String?   @unique
  sku                   String?
  itemQuantity          Int
  msrpPrice             Float
  singleItemSellingPrice Float
  clientId              String
  storeId               String
  discountAmount        Float
  percentDiscount       Float
  hasVariants           Boolean   @default(false)
  packIds               String[]  @default([])
  packs                 Pack[]
  variants              Json[]    
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  fileUploadId          String?   
  client                Clients   @relation(fields: [clientId], references: [id])
  store                 Stores    @relation(fields: [storeId], references: [id])
  productSuppliers      ProductSupplier[] // New relation
  sales                 Sales[]
  fileUpload            FileUploadInventory? @relation(fields: [fileUploadId], references: [id])
  purchaseOrders        PurchaseOrders[]
}

model Pack {
  id                    String    @id @default(uuid())
  productId             String
  minimumSellingQuantity Int
  totalPacksQuantity    Int
  orderedPacksPrice     Float
  discountAmount        Float
  percentDiscount       Float
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  product               Products  @relation(fields: [productId], references: [id])
}

model FileUploadInventory {
  id         String      @id @default(cuid())
  fileHash   String      @unique
  fileName   String
  uploadedAt DateTime    @default(now())
  storeId    String?
  status     String      @default("pending") // pending, processing, completed, failed
  error      String?
  products   Products[]
  store      Stores?     @relation(fields: [storeId], references: [id])
  errorLogs  ErrorLog[]
}

model ErrorLog {
  id           String    @id @default(cuid())
  fileUploadId String
  rowNumber    Int
  error        String
  createdAt    DateTime  @default(now())
  fileUpload   FileUploadInventory @relation(fields: [fileUploadId], references: [id])
}


model FileUploadSales {
  id         String   @id @default(cuid())
  fileHash   String   @unique
  fileName   String
  uploadedAt DateTime @default(now())
  storeId    String?
  Store      Stores?   @relation(fields: [storeId], references: [id])
  Sale       Sales[]
}